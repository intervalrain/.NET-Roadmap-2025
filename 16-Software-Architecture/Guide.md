# Chapter 16.1: Layered Architecture

## 前言

歡迎來到最後一章！到目前為止，我們已經學習了語言、框架、工具和各種函式庫。現在，是時候將所有這些知識片段組合在一起，從一個更高的視角來審視我們的應用程式——這就是 **軟體架構 (Software Architecture)**。

軟體架構關乎的是如何組織和安排一個系統的各個部分，以及它們之間的關係和互動原則。我們將探討的第一個、也是最傳統的架構模式，就是 **分層架構 (Layered Architecture)**。

## 什麼是分層架構？

分層架構將一個應用程式的關注點 (concerns) 分割成堆疊在一起的、水平的「層 (Layers)」。每一層都有其特定的職責，並且只與其緊鄰的上下層進行通訊。

一個典型的三層架構 (3-Tier Architecture) 包含：

1.  **表現層 (Presentation Layer)**：
    - **職責**：負責處理使用者介面 (UI) 和使用者互動。在 Web 應用中，這通常是 ASP.NET Core 的 MVC 或 Razor Pages 專案，負責處理 HTTP 請求、顯示資料和接收使用者輸入。
    - **它不知道**：資料是如何被儲存或獲取的，它只知道如何向業務層請求資料和提交操作。

2.  **業務邏輯層 (Business Logic Layer, BLL)**：
    - **職責**：包含應用程式的核心業務規則和邏輯。這是應用程式的「心臟」。它協調來自表現層的請求，執行業務計算和驗證，並呼叫資料存取層來讀寫資料。
    - **它不知道**：資料具體儲存在哪個資料庫（SQL Server? PostgreSQL?），也不知道 UI 是如何呈現的。

3.  **資料存取層 (Data Access Layer, DAL)**：
    - **職責**：負責處理與資料庫之間的所有通訊。它包含了使用 EF Core 或 Dapper 來查詢和儲存資料的程式碼 (Repositories)。
    - **它不知道**：這些資料將被用於何種業務目的。

## 依賴關係原則

分層架構最重要的一個原則是 **依賴方向**。上層可以依賴於下層，但下層 **絕對不能** 依賴於上層。
- **正確**：表現層 -> 業務邏輯層 -> 資料存取層
- **錯誤**：資料存取層 -> 業務邏輯層

這確保了層與層之間的單向依賴，從而實現了關注點分離。

## 優點與缺點

**優點：**
- **簡單直觀**：易於理解和實現，是許多開發人員入門時學習的第一個架構。
- **關注點分離**：不同層次的開發人員可以專注於自己的領域（例如，前端開發人員專注於 UI，後端開發人員專注於業務邏輯）。

**缺點：**
- **容易變得僵化**：隨著應用程式變得複雜，可能會出現「滲漏」，即下層的邏輯滲透到上層。例如，在表現層中出現了業務邏輯。
- **單體特性**：它天然地傾向於形成一個「單體 (Monolith)」應用，即整個應用程式被部署為一個單元。這使得獨立擴展或部署某個特定功能變得困難。
- **資料庫中心**：傳統的分層架構常常以資料庫為中心來設計，業務邏輯層可能與資料存取層過於緊密地耦合。

## 結語

分層架構是一個非常基礎且重要的架構模式。對於許多中小型應用程式來說，它是一個非常好的起點。然而，當面對更複雜、需要更高靈活性和可擴展性的系統時，我們就需要探索更現代的架構模式。

---

# Chapter 16.2: Microservices Architecture

## 前言

與將所有功能都建構在一個單一應用程式中的「單體架構」相反，**微服務架構 (Microservices Architecture)** 提出了一種完全不同的方法：將一個大型應用程式，拆分成一組小型的、獨立的、可獨立部署的服務。

## 什麼是微服務？

每個微服務都圍繞著一項特定的 **業務能力 (Business Capability)** 來建構（例如：訂單服務、使用者服務、支付服務）。

**核心特性：**
- **單一職責**：每個服務都只做一件事，並把它做好。
- **獨立性**：
    - **獨立開發**：不同的團隊可以獨立地開發和維護自己的服務。
    - **獨立部署**：可以更新或部署某個服務，而無需重新部署整個應用程式。
    - **獨立擴展**：可以根據每個服務的具體負載，獨立地對其進行擴展（例如，為「產品目錄」服務增加更多實例，而「訂單」服務則不需要）。
- **技術異構性**：每個服務都可以選擇最適合其業務場景的技術棧（例如，訂單服務用 .NET 和 SQL Server，推薦服務用 Python 和 NATS）。
- **去中心化資料管理**：每個微服務都擁有自己 **私有的資料庫**。其他服務不能直接存取這個資料庫，而必須透過該服務提供的 API 來進行通訊。


## 微服務的挑戰

微服務架構雖然帶來了巨大的靈活性和擴展性，但也引入了分散式系統的固有複雜性：

- **服務間通訊**：服務如何互相發現和通訊？（我們在第八章中學習的 HttpClient 和訊息佇列就是為了解決這個問題）。
- **分散式交易**：一個跨越多個服務的操作（例如「下訂單」可能需要更新庫存、處理支付、建立訂單），如何保證其資料一致性？（這通常需要使用 Sagas 等進階模式）。
- **可觀測性**：如何追蹤一個請求在眾多服務之間的完整路徑？（我們在第十四章學習的可觀測性工具就是答案）。
- **部署與維運複雜性**：管理數十個服務的部署和維運，比管理一個單體應用要複雜得多。（我們在第十章學習的容器和 Kubernetes 正是為此而生）。

## 結語

微服務架構是一種非常強大的模式，它能夠建構出極具彈性、可擴展和可維護的大型複雜系統。然而，它並非「銀彈」。採用微服務意味著你需要擁抱自動化 (DevOps)，並準備好應對分散式系統帶來的各種挑戰。對於許多專案來說，從一個設計良好的「模組化單體 (Modular Monolith)」開始，在真正需要時再逐步演進到微服務，可能是一條更務實的路徑。

---

# Chapter 16.3: Clean Architecture

## 前言

無論是分層架構還是微服務，我們都需要一個清晰的指導原則來組織服務內部的程式碼。**乾淨架構 (Clean Architecture)**，由 Robert C. Martin (Uncle Bob) 提出，正是這樣一種架構思想。它的核心目標是 **關注點分離 (Separation of Concerns)**，並建立一個獨立於框架、UI 和資料庫的、可測試的業務邏輯核心。

## 依賴原則 (The Dependency Rule)

乾淨架構最核心、最嚴格的規則就是 **依賴原則**：

**原始碼的依賴關係，必須總是從外層指向內層。**

這意味著，內層的任何東西，都不能知道關於外層的任何事情。特別是，內層的程式碼不能引用任何包含外層資訊的變數、函式或類別。

## 乾淨架構的層次

乾淨架構通常被描繪成一組同心圓：

1.  **Entities (實體層)**：
    - **職責**：代表了整個企業範圍內的、最核心的業務規則和資料結構。它們是最穩定、最不容易變動的程式碼。
    - **內容**：核心的領域物件 (Domain Objects)。

2.  **Use Cases / Application Business Rules (應用業務規則層)**：
    - **職責**：包含了特定於該應用程式的業務邏輯。它協調實體來完成特定的使用案例（例如「建立一個使用者」、「下一個訂單」）。
    - **內容**：應用程式的服務、我們在 MediatR 章節中學到的 Commands 和 Queries。
    - **關鍵**：這一層 **不知道** 任何關於 UI、資料庫或外部框架的細節。它只定義了它需要什麼樣的介面（例如 `IUserRepository`），而這些介面的具體實現則由外層提供。

3.  **Interface Adapters (介面配接器層)**：
    - **職責**：這一層是「轉換器」。它將來自最外層（UI, 資料庫）的資料，轉換成內層（Use Cases, Entities）方便使用的格式，反之亦然。
    - **內容**：
        - **Controllers / Presenters**：將 HTTP 請求轉換為內層的呼叫，並將內層的結果轉換為 HTTP 回應。
        - **Repositories (倉儲)**：實作由應用層定義的倉儲介面，負責與資料庫進行實際的通訊。

4.  **Frameworks & Drivers (框架與驅動層)**：
    - **職責**：這是最外層，包含了所有具體的實現細節。
    - **內容**：Web 框架 (ASP.NET Core)、資料庫 (EF Core)、UI 框架、訊息佇列客戶端等。

## 乾淨架構的優點

- **獨立於框架**：核心的業務邏輯不依賴於任何 Web 框架。理論上，你可以輕易地將 UI 從 Web 替換為桌面應用，而無需修改任何業務邏輯。
- **可測試性極高**：由於核心業務邏輯不依賴於外部細節，它們可以被非常輕鬆地進行單元測試。
- **獨立於 UI**：可以輕易地更換 UI，而業務邏輯保持不變。
- **獨立於資料庫**：你可以將資料庫從 SQL Server 換成 PostgreSQL，而只需要修改最外層的資料庫實現，核心業務邏輯完全不受影響。

## 結語

乾淨架構為我們提供了一個藍圖，用於建構一個可維護、可適應、可測試的、真正專業的軟體系統。它透過嚴格的依賴原則，保護了我們最寶貴的資產——核心業務邏輯——使其免受外部易變因素的影響。雖然它需要更多的前期規劃，但對於任何期望長期發展和演進的複雜專案來說，遵循乾淨架構的原則將會帶來巨大的回報。